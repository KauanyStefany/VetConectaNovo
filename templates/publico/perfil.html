{% extends "base_publica.html" %}
{% block conteudo %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card-perfil p-4 d-flex flex-row align-items-start gap-4">
                <!-- Coluna da foto e upload -->
                <div class="d-flex flex-column align-items-center" style="min-width: 160px;">
                    <img id="preview-foto"
                         src="{{ usuario.foto or '/static/img/user-default.png' }}"
                         class="rounded-circle mb-2"
                         style="width:120px; height:120px; object-fit:cover; border: 3px solid #28a745;"
                         alt="Foto do perfil">
                    <form action="/perfil/alterar-foto" method="post" enctype="multipart/form-data" class="w-100 mb-2">
                        <label for="foto" class="form-label small mb-1 text-center w-100">Selecionar Nova Foto</label>
                        <input type="file"
                               class="form-control form-control-sm mb-1 text-center"
                               style="max-width: 180px;"
                               id="foto"
                               name="foto"
                               accept="image/*">
                        <div class="form-text small mb-2 text-center">JPG, JPEG ou PNG</div>
                        <div class="d-flex gap-2 justify-content-center w-100">
                            <button type="submit" class="btn btn-sm btn-outline-primary" id="btn-alterar" disabled>
                                <i class="bi-camera"></i> Alterar Foto
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-cancelar" onclick="cancelarSelecao()" style="display: none;">
                                <i class="bi-x"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Coluna dos dados do usuário -->
                <div class="flex-grow-1">
                    <form action="/perfil/atualizar" method="post" class="w-100">
                        <div class="mb-3">
                            <span class="badge bg-success"><i class="bi bi-patch-check-fill"></i> Verificado</span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nome</label>
                            <input type="text" class="form-control" name="nome" value="{{ usuario.nome or '' }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">E-mail</label>
                            <input type="email" class="form-control" name="email" value="{{ usuario.email or '' }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Telefone</label>
                            <input type="text" class="form-control" name="telefone" value="{{ usuario.telefone or '' }}">
                        </div>
                        {% if usuario.perfil == 'veterinario' %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">CRMV</label>
                            <input type="text" class="form-control" name="crmv" value="{{ usuario.crmv or '' }}" readonly>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Bio</label>
                            <textarea class="form-control" name="bio" rows="2">{{ usuario.bio or '' }}</textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.getElementById('foto').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const previewImg = document.getElementById('preview-foto');
    const btnAlterar = document.getElementById('btn-alterar');
    const btnCancelar = document.getElementById('btn-cancelar');

    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            previewImg.src = event.target.result; // Troca a imagem imediatamente
            btnAlterar.disabled = false;
            btnCancelar.style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    } else {
        btnAlterar.disabled = true;
        btnCancelar.style.display = 'none';
        previewImg.src = "{{ usuario.foto or '/static/img/user-default.png' }}";
    }
});

function cancelarSelecao() {
    document.getElementById('foto').value = '';
    document.getElementById('btn-alterar').disabled = true;
    document.getElementById('btn-cancelar').style.display = 'none';
    document.getElementById('preview-foto').src = "{{ usuario.foto or '/static/img/user-default.png' }}";
}
</script>
{% endblock %}